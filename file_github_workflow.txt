name: Deploy VEED MCP Server

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test:
    name: Test Server
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm install
    
    - name: Start server for testing
      run: |
        echo "üöÄ Starting VEED MCP Server..."
        timeout 15s npm start &
        sleep 8
        echo "‚úÖ Server started"
    
    - name: Test health endpoint
      run: |
        echo "üîç Testing health endpoint..."
        curl -f http://localhost:3000/health || exit 1
        echo "‚úÖ Health check passed"
    
    - name: Test tools endpoint
      run: |
        echo "üîç Testing tools endpoint..."
        curl -f -X POST -H "Content-Type: application/json" -d '{}' http://localhost:3000/tools/list || exit 1
        echo "‚úÖ Tools endpoint working"
    
    - name: Test root endpoint
      run: |
        echo "üîç Testing root endpoint..."
        curl -f http://localhost:3000/ || exit 1
        echo "‚úÖ Root endpoint working"

  build:
    name: Build for GitHub Pages
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm install
    
    - name: Create GitHub Pages build
      run: |
        echo "üì¶ Building for GitHub Pages..."
        mkdir -p dist
        
        # Copy all files to dist
        cp package.json dist/
        cp server.js dist/
        cp index.html dist/
        cp README.md dist/
        cp vercel.json dist/
        
        # Create a simple landing page
        cat > dist/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>VEED MCP Server - GitHub Pages</title>
            <style>
                body {
                    font-family: Arial, sans-serif;
                    max-width: 800px;
                    margin: 0 auto;
                    padding: 20px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    min-height: 100vh;
                }
                .container {
                    background: rgba(255,255,255,0.1);
                    padding: 30px;
                    border-radius: 15px;
                    backdrop-filter: blur(10px);
                }
                h1 { color: #fff; text-align: center; }
                .status { padding: 15px; border-radius: 8px; margin: 15px 0; }
                .info { background: rgba(33, 150, 243, 0.4); }
                .warning { background: rgba(255, 193, 7, 0.4); }
                .success { background: rgba(76, 175, 80, 0.4); }
                code {
                    background: rgba(0,0,0,0.3);
                    padding: 3px 8px;
                    border-radius: 4px;
                    font-family: monospace;
                    font-size: 14px;
                }
                .endpoint {
                    background: rgba(0,0,0,0.2);
                    padding: 15px;
                    border-radius: 8px;
                    margin: 15px 0;
                }
                a {
                    color: #fff;
                    text-decoration: underline;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>üé¨ VEED MCP Server</h1>
                
                <div class="status info">
                    <strong>üìç Deployment Status:</strong><br>
                    ‚úÖ Successfully deployed to GitHub Pages!
                </div>

                <div class="status warning">
                    <strong>‚ö†Ô∏è Important Note:</strong><br>
                    GitHub Pages serves static files only. For a fully functional MCP server, deploy to:
                    <ul>
                        <li><strong>Vercel</strong> (recommended): <a href="https://vercel.com" target="_blank">vercel.com</a></li>
                        <li><strong>Railway</strong>: <a href="https://railway.app" target="_blank">railway.app</a></li>
                        <li><strong>Heroku</strong>: <a href="https://heroku.com" target="_blank">heroku.com</a></li>
                    </ul>
                </div>

                <div class="status success">
                    <strong>üöÄ Quick Deploy Links:</strong><br>
                    <a href="https://vercel.com/new/clone?repository-url=https://github.com/YOUR_USERNAME/veed-mcp-server" target="_blank">
                        Deploy to Vercel
                    </a>
                </div>

                <h2>üìÅ Repository Contents</h2>
                <div class="endpoint">
                    <strong>Files Available:</strong>
                    <ul>
                        <li><code>server.js</code> - Main MCP server</li>
                        <li><code>package.json</code> - Dependencies</li>
                        <li><code>vercel.json</code> - Vercel config</li>
                        <li><code>README.md</code> - Documentation</li>
                    </ul>
                </div>

                <h2>üîß Next Steps</h2>
                <ol>
                    <li>Deploy to a Node.js hosting platform (Vercel recommended)</li>
                    <li>Update your UUID in <code>server.js</code></li>
                    <li>Test the live endpoints</li>
                    <li>Connect to GPT using your deployment URL</li>
                </ol>

                <div class="status info">
                    <strong>üÜî Remember:</strong> Update your VEED UUID in the server.js file before deploying!
                </div>
            </div>
        </body>
        </html>
        EOF
        
        echo "‚úÖ GitHub Pages build ready"
    
    - name: Upload GitHub Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './dist'

  deploy-pages:
    name: Deploy to GitHub Pages
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    permissions:
      contents: read
      pages: write
      id-token: write
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

  notify:
    name: Deployment Notification
    needs: [test, deploy-pages]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Deployment Summary
      run: |
        echo "üéâ VEED MCP Server Deployment Complete!"
        echo ""
        echo "üìä Status Summary:"
        echo "‚úÖ Tests: ${{ needs.test.result }}"
        echo "‚úÖ GitHub Pages: ${{ needs.deploy-pages.result }}"
        echo ""
        echo "üåê Your server is available at:"
        echo "https://yourusername.github.io/veed-mcp-server"
        echo ""
        echo "üöÄ For full functionality, deploy to:"
        echo "‚Ä¢ Vercel: https://vercel.com/new"
        echo "‚Ä¢ Railway: https://railway.app"
        echo ""
        echo "üîß Don't forget to:"
        echo "‚Ä¢ Update your UUID in server.js"
        echo "‚Ä¢ Test all endpoints"
        echo "‚Ä¢ Connect to GPT"